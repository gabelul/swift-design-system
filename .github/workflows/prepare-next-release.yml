name: Prepare Next Release

# GitHub Releaseが公開された後、次のリリースに向けた準備PRを自動作成
on:
  release:
    types: [published]
  workflow_dispatch:  # 手動実行も可能にする

jobs:
  prepare-next-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Delete existing branch if exists
        run: |
          git push origin --delete chore/prepare-next-release 2>/dev/null || true

      - name: Create new branch
        run: |
          git checkout -b chore/prepare-next-release

      - name: Update CHANGELOG.md
        id: update_changelog
        run: |
          # "# 変更履歴"の後に新しいUnreleasedセクションを挿入（存在しない場合のみ）
          if ! grep -q "## \[未リリース\]" CHANGELOG.md; then
            # 一時ファイルを使用して挿入
            awk '/^# 変更履歴$/ {print; print ""; print "## [未リリース]"; print ""; print "なし"; print ""; next} 1' CHANGELOG.md > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          git add CHANGELOG.md
          git commit -m "chore: prepare for next release"

      - name: Push branch
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          git push origin chore/prepare-next-release

      - name: Create draft PR
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          gh pr create \
            --draft \
            --title "chore: prepare for next release" \
            --body "$(cat <<'EOF'
          次のリリースに向けた準備PRです。

          ## 変更内容
          - CHANGELOG.mdに新しい「未リリース」セクションを追加

          ## 開発フロー
          1. このPRをマージ
          2. 新機能・修正を開発する際、CHANGELOG.mdの「未リリース」セクションに変更を記録
          3. リリース準備時に「未リリース」→ バージョンセクションに変換してリリース

          このPRはドラフト状態で作成されています。準備ができたらレビュー依頼してください。
          EOF
          )"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
